<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
  <title>React Snake</title>
  <link rel="stylesheet" type="text/css" href="./css/skin.css">
</head>
<body>

<div id="root"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
<script type="text/babel">

var snake = function () {

	var RenderTableCell = React.createClass({
		render: function() {
      return (
      	<div className={this.props.className} >	
      	</div>
      );
    }
	});

	var RenderSnakeMovingTable = React.createClass({
	  render: function() {
	  	let row = this.props.controlObj.row || 10;
	  	let col = this.props.controlObj.col || 20;

	  	let snake = this.props.controlObj.snake || {};

      var table = [];
      let tr = [];

      let index = -1;
      //console.error(snake.body);

      let emptySpace = {
      	queue: [],
      	lookup: {},
    	};

			for (let i=0; i < row; i++) {
				let tr = [];				
				for (let j=0; j < col; j++) {
					index++;					
					if (snake.body && snake.body[index] === 1){
						tr.push(<td><RenderTableCell className="snake-body" /></td>);
					}else if(snake.item === index){
						tr.push(<td><RenderTableCell className="items" /></td>);
					}else{
						tr.push(<td><RenderTableCell className="" /></td>);
					
					}				  
				}				
			  table.push(<tr>{tr}</tr>);
			}			

      return (
      	<div className="snake-moving-table-container">
	      	<table className="snake-moving-table">   
	      		<tbody>     	
	        		{table}
	        	</tbody>
	      	</table>
      	</div>
      );
    }
	});


	var RenderGameControl = React.createClass({
		RenderGameControlHeader(){
			return(
				<div>
					<h1>{this.props.controlObj.ProjectName}</h1>
	      	<h3>Author : {this.props.controlObj.Author}</h3>
	      	<h3>Verson : {this.props.controlObj.Version}</h3>
				</div>
			);
		},

		RenderGameScore(){
			let score = this.props.controlObj.gameScore.toString() || "0";				
			
			return(
				<div className="game-score-container">
					{score}
				</div>
			);
		},

		renderRadioBtn(label,speed,defaultChecked){
			return(
				<label className="radio-btn-container">{label}
  				<input type="radio" name="radio"  defaultChecked={defaultChecked} onClick={ () => this.props.updateStates("speed",speed)}/>
 				 	<span className="radio-btn-checkmark"></span>
				</label>
			);
		},
	  render: function() {
	  	let btnText = this.props.controlObj.palse ? "Start Game" : "Palse" ;
      return (
      	<div className="game-control-container"> 
      		{this.RenderGameControlHeader()}
      		<button type="button" className="" onClick={()=> this.props.startGame()}>{btnText}</button>

      		<div className="display-panel">
      			<div className="display-panel-header">
      				Difficulty
      			</div>
    				{this.renderRadioBtn("Flash the Sloth",380)}
	  				{this.renderRadioBtn("Average Joe",230, true)}
	  				{this.renderRadioBtn("Fast and Furious",135)}
	  				{this.renderRadioBtn("Shining Finger!!!",75)}      			
      		</div>
      		      
      		<div className="display-panel">
      			<div className="display-panel-header">
      				Score
      			</div>
    				{this.RenderGameScore()}    			
      		</div>		
      	</div>
      );
    }
	});

	var ReactSnakeGame = React.createClass({
		getInitialState: function() {
      return {
      	controlObj : this.props.config
      }
    },
		handleKeyDown(event){
	    //right
	    if(event.keyCode == 39){
	      this.snakeDirection(0);
	    }
	    //down
	    else if(event.keyCode == 40){
	    	this.snakeDirection(1);
	    }
	    //left
	    else if(event.keyCode == 37){
	    	this.snakeDirection(2);
	    }
	    //up
	   	else if(event.keyCode == 38){
	   		this.snakeDirection(3);
	    }
		},
		componentWillMount() {
			//console.error("componentWillMount");
	    window.addEventListener('keydown', this.handleKeyDown);
	  },
	  componentWillUnmount() {
	    window.removeEventListener('keydown', this.handleKeyDown);
	  },	
    updateStates(key, value){
    	let controlObj = this.state.controlObj;
    	controlObj[key] = value;
    	this.setState({"controlObj": controlObj});    	
    },
    createItem(){
    	let col = this.state.controlObj.col;
    	let row = this.state.controlObj.row;
    	let snake = this.state.controlObj.snake;
      let emptySpace = [];

    	let index = -1;

			for (let i=0; i < row; i++) {							
				for (let j=0; j < col; j++) {
					index++;					
					if (snake.body && snake.body[index] !== 1){						
						emptySpace.push(index);
					}				  
				}	
			  
			}	
			snake.item = Math.floor(Math.random() * (emptySpace.length));
			//console.error
			this.updateStates("snake", snake);

  	},
    snakeDirection(direction){ 
    	let curr_direction = this.state.controlObj.direction;
    	if(curr_direction !== direction && Math.abs(direction - curr_direction) % 2 === 1 ){
    		this.updateStates("directionBuff", direction);
    	}  	
    },
    lose(){ 
			clearInterval(this.state.controlObj.intervalId);
    	this.updateStates("palse", true);
    	alert("you lose");
    },
    win(){ 
			clearInterval(this.state.controlObj.intervalId);
    	this.updateStates("palse", true);
    	alert("you win");
    },
    checker(snake){ 
    	let col = this.state.controlObj.col;
    	let row = this.state.controlObj.row;
    	if(snake.col >= col || snake.row >= row || snake.col < 0 || snake.row < 0 ){
    		return 0;
    	}
    	if(snake.head === snake.item ){
    		return 2;
    	}

    	return 1;    	
    },
    snakeMoving(){   
    	let direction = this.state.controlObj.directionBuff;
    	this.updateStates("direction", direction);

    	let snake = this.state.controlObj.snake;
	    let col = this.state.controlObj.col;
	    let row = this.state.controlObj.row;
	    let gameScore = this.state.controlObj.gameScore;
	  	
    	if(direction === 0){
    		snake.head = snake.head + 1;
    		snake.col++;

    	}else if(direction === 1){
    		snake.head = snake.head + col;  
    		snake.row++; 	

    	}else if(direction === 2){
    		snake.head = snake.head - 1;
    		snake.col--;

    	}else if(direction === 3){
    		snake.head = snake.head - col;
    		snake.row--;
    	}

    	if(snake.body[snake.head] === 1){
    		this.lose();
    	}
    	snake.queue.push(snake.head)
    	snake.body[snake.head] = 1;
    	let tail = snake.queue[0];
    	if(this.checker(snake) === 0){
    		this.lose();
    	}else if(this.checker(snake) === 1){
	    	snake.queue.shift();
	    	snake.body[tail] = 0;  
	    	this.updateStates("snake", snake);

    	}else{
	      let emptySpace = [];

	    	let index = -1;
	    	gameScore++;
	    	console.error(gameScore);
	    	this.updateStates("gameScore", gameScore);

				for (let i=0; i < row; i++) {							
					for (let j=0; j < col; j++) {
						index++;					
						if (snake.body && snake.body[index] !== 1){						
							emptySpace.push(index);
						}				  
					}	
				  
				}	
				if(emptySpace.length <= 2){
					win();
				}else{
					snake.item = Math.floor(Math.random() * (emptySpace.length));

					this.updateStates("snake", snake);
				}

    	}

    },


    startGame:function(){
    	if(this.state.controlObj.palse){
    		this.createItem();
    		let intervalId = setInterval(this.snakeMoving, this.state.controlObj.speed);
    		this.updateStates("intervalId", intervalId);
    		this.updateStates("palse", false);
    	}else{
    		clearInterval(this.state.controlObj.intervalId);
    		this.updateStates("palse", true);
    	}
    	
    },

	  render: function() {
      return (
			  <div className="game-screen-wrapper">

			    <RenderGameControl
			    	updateStates={this.updateStates}
			    	startGame={this.startGame}
			    	controlObj={this.state.controlObj}/>

			    <RenderSnakeMovingTable 
			    	controlObj={this.state.controlObj}
			    	updateStates={this.updateStates}/>

			  </div>
      );
    }
	});

	var destination = document.querySelector("#root");

	var config = {
		ProjectName: "React Snake",
		Author:   "Nan Sun",
		Version:  "1.0.0",

		palse: true,
		intervalId: 0,
		col:31,
		row:24,
		speed: 250,
		direction: 0,	
		directionBuff: 0, 
		gameScore: 0,
    snake:{
    	col: 2,
    	row: 0,
    	head: 2,
    	queue: [1,2],
    	body: {
    		1 : 1,
    		2 : 1
    	},
    	item: -1,
    }
	};


	ReactDOM.render(
	  <div>
	    <ReactSnakeGame config={config}/>
	  </div>,
	  destination
	);  
}

snake();
</script>
</html>