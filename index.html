<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
  <title>React Starter Template</title>
  <link rel="stylesheet" type="text/css" href="./css/skin.css">
</head>
<body>

<div id="root"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
<script type="text/babel">
var snake = function () {

	var SnakeTableCell = React.createClass({
		render: function() {
      return (
      	<span className={"snake-table-cell " + this.props.className} >	
      	</span>
      );
    }
	});

	var SnakeTable = React.createClass({
	  render: function() {
	  	let row = this.props.controlObj.row || 10;
	  	let col = this.props.controlObj.col || 20;

	  	let snake = this.props.controlObj.snake || {};

      var table = [];
      let tr = [];

      let index = -1;
      console.error(snake.body);

      let emptySpace = {
      	queue: [],
      	lookup: {},
    	};

			for (let i=0; i < row; i++) {
				let tr = [];				
				for (let j=0; j < col; j++) {
					index++;					
					if (snake.body && snake.body[index] === 1){
						tr.push(<td><SnakeTableCell className="snake" /></td>);
					}else if(snake.item === index){
						tr.push(<td><SnakeTableCell className="item" /></td>);
					}else{
						tr.push(<td><SnakeTableCell className="" /></td>);
					
					}				  
				}				
			  table.push(<tr>{tr}</tr>);
			}			

      return (
      	<table>   
      		<tbody>     	
        		{table}
        	</tbody>
      	</table>
      );
    }
	});

	var ControlPanel = React.createClass({
	  render: function() {
      return (
      	<div>   
  				<input type="radio" className="" name="gender" value="Low" onClick={() => this.props.updateStates("speed",700)}/> Low <br/>
  				<input type="radio" className="" name="gender" value="Mid" onClick={() => this.props.updateStates("speed",500)}/> Mid <br/>
  				<input type="radio" className="" name="gender" value="Hig" onClick={() => this.props.updateStates("speed",200)}/> Hig <br/>
  				<input type="radio" className="" name="gender" value="God" onClick={() => this.props.updateStates("speed",50)}/> God Like <br/>
      		<button type="button" className="" onClick={()=> this.props.startGame()}>Start Game</button>
      	</div>
      );
    }
	});

	var SnakeGame = React.createClass({
		getInitialState: function() {
      return {
      	controlObj : {
          palse: true,
          intervalId: 0,
	        col:20,
	        row:10,
	        speed: 1000,
	        direction:0,	        
	        snake:{
	        	col: 2,
	        	row: 0,
	        	head: 2,
	        	queue: [1,2],
	        	body: {
	        		1 : 1,
	        		2 : 1
	        	},
	        	item: -1,
	        }

      	}
      }
    },
		handleKeyDown(event){
	    //right
	    if(event.keyCode == 39){
	      this.snakeDirection(0);
	    }
	    //down
	    else if(event.keyCode == 40){
	    	this.snakeDirection(1);
	    }
	    //left
	    else if(event.keyCode == 37){
	    	this.snakeDirection(2);
	    }
	    //up
	   	else if(event.keyCode == 38){
	   		this.snakeDirection(3);
	    }
		},
		componentWillMount() {
			console.error("componentWillMount");
	    window.addEventListener('keydown', this.handleKeyDown);
	  },
	  componentWillUnmount() {
	    window.removeEventListener('keydown', this.handleKeyDown);
	  },	
    updateStates(key, value){
    	let controlObj = this.state.controlObj;
    	controlObj[key] = value;
    	this.setState({"controlObj": controlObj});    	
    },
    createItem(){
    	let col = this.state.controlObj.col;
    	let row = this.state.controlObj.row;
    	let snake = this.state.controlObj.snake;
      let emptySpace = [];

    	let index = -1;

			for (let i=0; i < row; i++) {							
				for (let j=0; j < col; j++) {
					index++;					
					if (snake.body && snake.body[index] !== 1){						
						emptySpace.push(index);
					}				  
				}	
			  
			}	
			snake.item = Math.floor(Math.random() * (emptySpace.length));
			console.error
			this.updateStates("snake", snake);

  	},
    snakeDirection(direction){ 
    	let curr_direction = this.state.controlObj.direction;
    	if(curr_direction !== direction && Math.abs(direction - curr_direction) % 2 === 1 ){
    		this.updateStates("direction", direction);
    	}  	
    },
    lose(){ 
			clearInterval(this.state.controlObj.intervalId);
    	this.updateStates("palse", true);
    	alert("you lose");
    },
    checker(snake){ 
    	let col = this.state.controlObj.col;
    	let row = this.state.controlObj.row;
    	if(snake.col >= col || snake.row >= row || snake.col < 0 || snake.row < 0 ){
    		return 0;
    	}
    	if(snake.head === snake.item ){
    		return 2;
    	}

    	return 1;    	
    },
    snakeMoving(){   
    	let direction = this.state.controlObj.direction;
    	let snake = this.state.controlObj.snake;
	    let col = this.state.controlObj.col;
	    let row = this.state.controlObj.row;
	  	
    	if(direction === 0){
    		snake.head = snake.head + 1;
    		snake.col++;

    	}else if(direction === 1){
    		snake.head = snake.head + col;  
    		snake.row++; 	

    	}else if(direction === 2){
    		snake.head = snake.head - 1;
    		snake.col--;

    	}else if(direction === 3){
    		snake.head = snake.head - col;
    		snake.row--;
    	}

    	if(snake.body[snake.head] === 1){
    		this.lose();
    	}
    	snake.queue.push(snake.head)
    	snake.body[snake.head] = 1;
    	let tail = snake.queue[0];
    	if(this.checker(snake) === 0){
    		this.lose();
    	}else if(this.checker(snake) === 1){
	    	snake.queue.shift();
	    	snake.body[tail] = 0;  
	    	this.updateStates("snake", snake);
    	}else{
	      let emptySpace = [];

	    	let index = -1;

				for (let i=0; i < row; i++) {							
					for (let j=0; j < col; j++) {
						index++;					
						if (snake.body && snake.body[index] !== 1){						
							emptySpace.push(index);
						}				  
					}	
				  
				}	
				snake.item = Math.floor(Math.random() * (emptySpace.length));

				this.updateStates("snake", snake);
    	}

    },
    startGame:function(){

    	if(this.state.controlObj.palse){
    		this.createItem();
    		let intervalId = setInterval(this.snakeMoving, this.state.controlObj.speed);
    		this.updateStates("intervalId", intervalId);
    		this.updateStates("palse", false);
    	}else{
    		clearInterval(this.state.controlObj.intervalId);
    		this.updateStates("palse", true);
    	}
    	
    },
	  render: function() {
      return (
			  <div>
			    <SnakeTable 
			    	controlObj={this.state.controlObj}
			    	updateStates={this.updateStates}/>

			    <ControlPanel
			    	updateStates={this.updateStates}
			    	startGame={this.startGame}/>
			  </div>
      );
    }
	});

	var destination = document.querySelector("#root");
	
	ReactDOM.render(
	  <div>
	    <SnakeGame/>
	  </div>,
	  destination
	);  
}

snake();
</script>
</html>